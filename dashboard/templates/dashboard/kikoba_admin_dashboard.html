{% extends "dashboard/base_dashboard_new.html" %}
{% load static %}
{% load i18n %}

{% block title %}{{ page_title|default:"Admin Dashboard" }}{% endblock %}

{% block page_title %}{{ page_title|default:"Admin Dashboard" }}{% endblock %}

{% block dashboard_content %}

{% if is_superuser_dashboard %}
    <!-- Superuser: List of all Kikobas -->
    <div class="p-6 bg-white shadow-xl rounded-lg">
        <h2 class="text-2xl font-semibold text-gray-700 mb-6 border-b pb-3">Manage Kikobas</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kikoba Number</th>
                        <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for kikoba in all_kikobas %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-4 px-4 whitespace-nowrap">{{ kikoba.name }}</td>
                            <td class="py-4 px-4 whitespace-nowrap">{{ kikoba.kikoba_number }}</td>
                            <td class="py-4 px-4 whitespace-nowrap">
                                <a href="?kikoba_id={{ kikoba.id }}" class="text-blue-600 hover:text-blue-800 font-medium">Manage</a>
                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3" class="text-center py-6 text-gray-500">No Kikobas found.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% else %}
    <!-- Regular Admin Dashboard for a Specific Kikoba -->
    <div class="flex flex-col space-y-8">
        <!-- Kikoba Details Section -->
        <section id="kikoba-details" class="p-6 bg-white shadow-xl rounded-lg">
                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-y-4 mb-6 border-b pb-3">
                                <h2 class="text-2xl font-semibold text-gray-700">{% trans "Kikoba Details" %}</h2>
                <a href="{% url 'groups:kikoba_contribution_config' kikoba_id=current_kikoba.id %}" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded inline-flex items-center">
                                        <i class="fas fa-cog mr-2"></i> {% trans "Configure Contributions" %}
                </a>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                <div><span class="font-medium text-gray-600">{% trans "Kikoba Number:" %}</span> <span class="text-gray-800">{{ current_kikoba.kikoba_number }}</span></div>
                <div><span class="font-medium text-gray-600">{% trans "Location:" %}</span> <span class="text-gray-800">{{ current_kikoba.location }}</span></div>
                <div><span class="font-medium text-gray-600">{% trans "Members:" %}</span> <span class="text-gray-800">{{ total_members }}</span></div>
                <div><span class="font-medium text-gray-600">{% trans "Created:" %}</span> <span class="text-gray-800">{{ current_kikoba.created_at|date:"d M Y" }}</span></div>
            </div>
        </section>

        <!-- Analytics Dashboard -->
        <div class="space-y-6">
            <!-- Key Metrics Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <!-- Total Members -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 uppercase">Total Members</p>
                            <p class="text-3xl font-bold text-gray-900">{{ total_members }}</p>
                        </div>
                        <div class="bg-blue-100 rounded-full p-3">
                            <i class="fas fa-users fa-2x text-blue-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Collected -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 uppercase">Total Collected</p>
                            <p class="text-2xl font-bold text-gray-900">{{ total_collected|floatformat:0 }} TZS</p>
                            <p class="text-xs text-gray-500 mt-1">{{ total_contributions_count|add:total_shares_count }} contributions</p>
                        </div>
                        <div class="bg-green-100 rounded-full p-3">
                            <i class="fas fa-coins fa-2x text-green-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Total Loans -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-indigo-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 uppercase">Total Loans Given</p>
                            <p class="text-2xl font-bold text-gray-900">{{ total_loans_amount|floatformat:0 }} TZS</p>
                            <p class="text-xs text-gray-500 mt-1">{{ total_loans }} loans</p>
                        </div>
                        <div class="bg-indigo-100 rounded-full p-3">
                            <i class="fas fa-hand-holding-usd fa-2x text-indigo-600"></i>
                        </div>
                    </div>
                </div>

                <!-- Outstanding Balance -->
                <div class="bg-white rounded-lg shadow-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 uppercase">Outstanding Balance</p>
                            <p class="text-2xl font-bold text-gray-900">{{ outstanding_balance|floatformat:0 }} TZS</p>
                            <p class="text-xs text-gray-500 mt-1">{{ active_loans_count }} active loans</p>
                        </div>
                        <div class="bg-red-100 rounded-full p-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-red-600"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contribution Breakdown -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Contribution Breakdown</h3>
                    <div class="space-y-4">
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ðŸ’° Regular Contributions</span>
                            <span class="font-bold text-gray-900">{{ total_contributions_amount|floatformat:0 }} TZS</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-gray-600">ðŸ“Š Share Contributions</span>
                            <span class="font-bold text-gray-900">{{ total_shares_amount|floatformat:0 }} TZS</span>
                        </div>
                        <div class="border-t pt-3 flex justify-between items-center">
                            <span class="text-gray-700 font-semibold">Total</span>
                            <span class="font-bold text-green-600 text-xl">{{ total_collected|floatformat:0 }} TZS</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-lg p-6">
                    <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Quick Actions</h3>
                    <div class="grid grid-cols-2 gap-3">
                        <a href="{% url 'dashboard:invite_member' %}" class="flex flex-col items-center p-4 bg-purple-50 hover:bg-purple-100 rounded-lg transition-colors">
                            <i class="fas fa-user-plus text-purple-600 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Invite Member</span>
                        </a>
                        <a href="{% url 'dashboard:batch_contributions' %}" class="flex flex-col items-center p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors">
                            <i class="fas fa-coins text-green-600 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Add Contributions</span>
                        </a>
                        <a href="{% url 'dashboard:csv_contributions_import' %}" class="flex flex-col items-center p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors">
                            <i class="fas fa-file-csv text-blue-600 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">CSV Import</span>
                        </a>
                        <a href="{% url 'dashboard:kikoba_loans_management' %}" class="flex flex-col items-center p-4 bg-indigo-50 hover:bg-indigo-100 rounded-lg transition-colors">
                            <i class="fas fa-landmark text-indigo-600 mb-2"></i>
                            <span class="text-sm font-medium text-gray-700">Manage Loans</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow-lg p-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Recent Contributions</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Date</th>
                                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-500 uppercase">Member</th>
                                <th class="px-4 py-2 text-right text-xs font-semibold text-gray-500 uppercase">Amount</th>
                                <th class="px-4 py-2 text-center text-xs font-semibold text-gray-500 uppercase">Status</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            {% for contribution in recent_contributions %}
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm text-gray-900">{{ contribution.date_contributed|date:"Y-m-d" }}</td>
                                <td class="px-4 py-3 text-sm text-gray-900">{{ contribution.member.name }}</td>
                                <td class="px-4 py-3 text-sm text-gray-900 text-right font-medium">{{ contribution.amount|floatformat:0 }} TZS</td>
                                <td class="px-4 py-3 text-center">
                                    {% if contribution.is_verified %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Verified</span>
                                    {% else %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="px-4 py-6 text-center text-gray-500">No recent contributions</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endif %}

{% endblock %}
