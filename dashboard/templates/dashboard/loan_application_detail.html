{% extends "dashboard/base_dashboard_new.html" %}
{% load static %}

{% block title %}Loan Application Detail - {{ application.member.name }}{% endblock %}

{% block content %}
<style>
    /* Print Styles */
    @media print {
        .no-print, nav, .navbar, .sidebar, .action-buttons {
            display: none !important;
        }
        body {
            background: white !important;
        }
        .loan-form-container {
            box-shadow: none !important;
            margin: 0 !important;
            padding: 20px !important;
        }
    }

    /* General Styling for a Clean Form Look */
    .loan-form-container {
        background: white;
        padding: 40px;
        margin: 20px auto;
        max-width: 900px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border-radius: 8px;
    }
    
    .loan-form-container h1 {
        text-align: center;
        color: #801336; /* MangiPurple */
        border-bottom: 3px solid #EE4540; /* MangiRed */
        padding-bottom: 10px;
        font-size: 24pt;
        margin-bottom: 30px;
    }
    
    .section-header {
        color: #801336; /* MangiPurple */
        font-weight: bold;
        margin-top: 30px;
        margin-bottom: 15px;
        padding: 8px 0;
        border-bottom: 2px solid #C72C41; /* MangiRedDark */
        font-size: 14pt;
    }
    
    .form-row {
        margin-bottom: 20px;
        clear: both;
        overflow: auto; 
    }
    
    .form-row label {
        display: block;
        font-weight: bold;
        margin-bottom: 5px;
        font-size: 11pt;
        color: #20142C;
    }
    
    .form-value {
        width: 100%;
        padding: 10px;
        border: 2px solid #801336; 
        border-radius: 4px; 
        box-sizing: border-box;
        margin-top: 5px;
        font-size: 11pt;
        background-color: #f9f9f9;
        min-height: 40px;
        color: #20142C;
    }
    
    .half-width {
        width: 48%; 
        float: left;
    }
    
    .right-half {
        margin-left: 4%;
    }
    
    .small-note {
        font-size: 9pt;
        color: #F44336; 
        margin-top: 5px;
        display: block;
    }

    /* Document/Signature Area Styling */
    .doc-area {
        border: 2px solid #510A32; 
        padding: 15px;
        border-radius: 5px;
        background-color: #FAFAFA; 
        margin-bottom: 20px;
    }
    
    .signature-box {
        border: 2px dashed #2196F3; 
        min-height: 80px;
        margin-top: 10px;
        text-align: center;
        padding: 10px;
        font-size: 9pt;
        color: #2196F3;
        background-color: #FFFFFF;
        border-radius: 4px;
    }
    
    .signature-box img {
        max-height: 60px;
        max-width: 200px;
    }
    
    .photo-placeholder {
        border: 2px solid #4CAF50;
        height: 100px;
        width: 100px;
        text-align: center;
        line-height: 100px;
        font-size: 9pt;
        color: #4CAF50;
        background-color: #FFFFFF;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .photo-placeholder img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* APPLICANT photo alignment */
    .applicant-photo-container {
        float: right;
        margin: -5px 0 10px 20px;
    }
    
    /* GUARANTOR photo alignment (inside doc-area) */
    .guarantor-photo-container {
        float: right;
        margin: 0 0 10px 20px;
    }
    
    .guarantor-details-container {
        overflow: hidden;
        margin-right: 120px;
    }

    /* Status Badge */
    .status-badge {
        display: inline-block;
        padding: 8px 20px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 11pt;
        margin-left: 15px;
    }
    
    .status-pending {
        background-color: #FFA726;
        color: white;
    }
    
    .status-approved {
        background-color: #66BB6A;
        color: white;
    }
    
    .status-rejected {
        background-color: #EF5350;
        color: white;
    }

    /* Action Buttons */
    .action-buttons {
        margin: 30px 0;
        text-align: center;
        padding: 20px;
        background-color: #f5f5f5;
        border-radius: 8px;
    }
    
    .btn-action {
        padding: 12px 30px;
        margin: 0 10px;
        border: none;
        border-radius: 5px;
        font-size: 12pt;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-approve {
        background-color: #66BB6A;
        color: white;
    }
    
    .btn-approve:hover {
        background-color: #4CAF50;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-reject {
        background-color: #EF5350;
        color: white;
    }
    
    .btn-reject:hover {
        background-color: #E53935;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-print {
        background-color: #801336;
        color: white;
    }
    
    .btn-print:hover {
        background-color: #510A32;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-back {
        background-color: #757575;
        color: white;
    }
    
    .btn-back:hover {
        background-color: #616161;
    }

    .agreement-box {
        font-size: 10pt;
        margin-bottom: 15px;
        border: 2px dashed #4CAF50;
        padding: 10px;
        background-color: #f0f9f0;
        border-radius: 5px;
    }

    /* Modal for Approval/Rejection */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 30px;
        border: 1px solid #888;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
    }
    
    .modal-header {
        color: #801336;
        font-size: 18pt;
        font-weight: bold;
        margin-bottom: 20px;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover,
    .close:focus {
        color: #000;
    }
    
    .modal textarea {
        width: 100%;
        min-height: 100px;
        padding: 10px;
        border: 2px solid #801336;
        border-radius: 4px;
        font-size: 11pt;
        font-family: Arial, sans-serif;
    }
    
    .modal-buttons {
        margin-top: 20px;
        text-align: right;
    }
</style>

<div class="loan-form-container">
    <h1>
        VICOBA LOAN APPLICATION FORM
        <span class="status-badge status-{{ application.status }}">
            {{ application.get_status_display }}
        </span>
    </h1>

    <!-- Application Info Header -->
    <div style="text-align: center; margin-bottom: 20px; color: #666; font-size: 10pt;">
        <strong>Application ID:</strong> #{{ application.id }} | 
        <strong>Date:</strong> {{ application.application_date|date:"d/m/Y" }} | 
        <strong>Kikoba:</strong> {{ application.kikoba.name }}
    </div>

    <div class="section-header">1. APPLICANT DETAILS</div>
    
    <div class="form-row">
        <div class="applicant-photo-container">
            <div class="photo-placeholder">
                {% if application.member.profile_picture %}
                    <img src="{{ application.member.profile_picture.url }}" alt="Applicant Photo">
                {% else %}
                    <div style="line-height: 100px;">Applicant Photo</div>
                {% endif %}
            </div>
        </div>
        <label>Full Name of Applicant</label>
        <div class="form-value">{{ application.member.name }}</div>
    </div>
    
    <div class="form-row">
        <div class="half-width">
            <label>VICOBA Member ID</label>
            <div class="form-value">{{ application.member.id }}</div>
        </div>
        <div class="half-width right-half">
            <label>National ID / Voter ID Number</label>
            <div class="form-value">
                {% if application.member.national_id %}
                    {{ application.member.national_id }}
                {% else %}
                    Not Provided
                {% endif %}
            </div>
            <span class="small-note">Required: ID Copy Attachment</span>
        </div>
    </div>

    <div class="form-row">
        <div class="half-width">
            <label>Phone Number</label>
            <div class="form-value">{{ application.member.phone_number }}</div>
        </div>
        <div class="half-width right-half">
            <label>Email Address</label>
            <div class="form-value">
                {% if application.member.email %}
                    {{ application.member.email }}
                {% else %}
                    Not Provided
                {% endif %}
            </div>
        </div>
    </div>

    <div class="section-header">2. LOAN DETAILS</div>
    
    <div class="form-row">
        <div class="half-width">
            <label>Requested Loan Amount (TZS)</label>
            <div class="form-value">{{ application.requested_amount|floatformat:2 }}</div>
        </div>
        <div class="half-width right-half">
            <label>Loan Product</label>
            <div class="form-value">
                {% if application.loan_product %}
                    {{ application.loan_product.name }}
                {% else %}
                    General Loan
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="form-row">
        <div class="half-width">
            <label>Interest Rate (Annual %)</label>
            <div class="form-value">
                {% if application.loan_product %}
                    {{ application.loan_product.interest_rate }}%
                {% else %}
                    N/A
                {% endif %}
            </div>
        </div>
        <div class="half-width right-half">
            <label>Repayment Period</label>
            <div class="form-value">
                {% if application.loan_product %}
                    {{ application.loan_product.min_duration_days }} - {{ application.loan_product.max_duration_days }} days
                {% else %}
                    To be determined
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="form-row">
        <label>Purpose of Loan</label>
        <div class="form-value">{{ application.purpose }}</div>
    </div>

    <div class="section-header">3. COLLATERAL (DHAMANA/REHANI)</div>
    
    <div class="form-row">
        <label>Description of Collateral Provided</label>
        <div class="form-value">
            {% if application.collateral_description %}
                {{ application.collateral_description }}
            {% else %}
                <em style="color: #999;">Collateral details to be provided or verified during approval process</em>
            {% endif %}
        </div>
        <span class="small-note">This may be household items, business assets, or share deposits.</span>
    </div>

    <div class="section-header">4. GUARANTORS (WADHAMINI)</div>

    {% if application.guarantors.all %}
        {% for guarantor in application.guarantors.all %}
        <div class="doc-area">
            <label>GUARANTOR {{ forloop.counter }}</label>
            <div class="form-row">
                <div class="guarantor-photo-container">
                    <div class="photo-placeholder">
                        {% if guarantor.member.profile_picture %}
                            <img src="{{ guarantor.member.profile_picture.url }}" alt="G{{ forloop.counter }} Photo">
                        {% else %}
                            <div style="line-height: 100px;">G{{ forloop.counter }} Photo</div>
                        {% endif %}
                    </div>
                </div>
                <div class="guarantor-details-container">
                    <div class="half-width"> 
                        <label>Full Name</label>
                        <div class="form-value">{{ guarantor.member.name }}</div>
                    </div>
                    <div class="half-width right-half"> 
                        <label>Member ID</label>
                        <div class="form-value">{{ guarantor.member.id }}</div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <div class="half-width">
                    <label>Phone Number</label>
                    <div class="form-value">{{ guarantor.member.phone_number }}</div>
                </div>
                <div class="half-width right-half">
                    <label>Guarantee Amount (TZS)</label>
                    <div class="form-value">
                        {% if guarantor.guaranteed_amount %}
                            {{ guarantor.guaranteed_amount|floatformat:2 }}
                        {% else %}
                            Full Amount
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label>Signature of Guarantor {{ forloop.counter }}</label>
                <div class="signature-box">
                    {% if guarantor.signature %}
                        <img src="{{ guarantor.signature.url }}" alt="Guarantor {{ forloop.counter }} Signature">
                    {% else %}
                        Signature/Digital Capture Area - To be captured during approval
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <div class="doc-area">
            <label>GUARANTOR 1</label>
            <div class="form-row">
                <div class="guarantor-photo-container">
                    <div class="photo-placeholder">G1 Photo</div>
                </div>
                <div class="guarantor-details-container">
                    <div class="half-width"> 
                        <label>Full Name</label>
                        <div class="form-value"><em style="color: #999;">To be provided</em></div>
                    </div>
                    <div class="half-width right-half"> 
                        <label>Member ID</label>
                        <div class="form-value"><em style="color: #999;">To be provided</em></div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label>Signature of Guarantor 1</label>
                <div class="signature-box">Signature/Digital Capture Area</div>
            </div>
        </div>

        <div class="doc-area">
            <label>GUARANTOR 2</label>
            <div class="form-row">
                <div class="guarantor-photo-container">
                    <div class="photo-placeholder">G2 Photo</div>
                </div>
                <div class="guarantor-details-container">
                    <div class="half-width"> 
                        <label>Full Name</label>
                        <div class="form-value"><em style="color: #999;">To be provided</em></div>
                    </div>
                    <div class="half-width right-half"> 
                        <label>Member ID</label>
                        <div class="form-value"><em style="color: #999;">To be provided</em></div>
                    </div>
                </div>
            </div>
            <div class="form-row">
                <label>Signature of Guarantor 2</label>
                <div class="signature-box">Signature/Digital Capture Area</div>
            </div>
        </div>
    {% endif %}

    <div class="section-header">5. APPLICANT AGREEMENT & SIGNATURE</div>
    
    <div class="agreement-box">
        <strong>Declaration:</strong> I certify that all information provided in this application is correct and accurate. 
        I agree to abide by all VICOBA loan repayment terms and conditions. I understand that failure to repay 
        may result in penalties as per VICOBA bylaws, and my guarantors will be held responsible.
    </div>
    
    <div class="form-row doc-area">
        <div class="half-width">
            <label>APPLICANT SIGNATURE</label>
            <div class="signature-box">
                {% if application.applicant_signature %}
                    <img src="{{ application.applicant_signature.url }}" alt="Applicant Signature">
                {% else %}
                    Signature/Digital Capture Area
                {% endif %}
            </div>
        </div>
        <div class="half-width right-half">
            <label>Date of Application</label>
            <div class="form-value">{{ application.application_date|date:"d/m/Y" }}</div>
        </div>
    </div>

    {% if application.status == 'approved' or application.status == 'rejected' %}
    <div class="section-header">6. DECISION DETAILS</div>
    
    <div class="form-row">
        <div class="half-width">
            <label>Decision By</label>
            <div class="form-value">{{ application.decision_by.name }}</div>
        </div>
        <div class="half-width right-half">
            <label>Decision Date</label>
            <div class="form-value">{{ application.decision_date|date:"d/m/Y H:i" }}</div>
        </div>
    </div>
    
    {% if application.remarks %}
    <div class="form-row">
        <label>Decision Remarks</label>
        <div class="form-value">{{ application.remarks }}</div>
    </div>
    {% endif %}
    {% endif %}

    <!-- Action Buttons (only show if pending) -->
    {% if application.status == 'pending' %}
    <div class="action-buttons no-print">
        <button type="button" class="btn-action btn-approve" onclick="openApprovalModal()">
            ‚úì APPROVE LOAN
        </button>
        <button type="button" class="btn-action btn-reject" onclick="openRejectionModal()">
            ‚úó REJECT LOAN
        </button>
        <button type="button" class="btn-action btn-print" onclick="window.print()">
            üñ® PRINT FORM
        </button>
        <a href="{% url 'dashboard:kikoba_loans_management' %}" class="btn-action btn-back">‚Üê BACK TO LOANS</a>
    </div>
    {% else %}
    <div class="action-buttons no-print">
        <button type="button" class="btn-action btn-print" onclick="window.print()">
            üñ® PRINT FORM
        </button>
        <a href="{% url 'dashboard:kikoba_loans_management' %}" class="btn-action btn-back">‚Üê BACK TO LOANS</a>
    </div>
    {% endif %}

</div>

<!-- Approval Modal -->
<div id="approvalModal" class="modal no-print">
    <div class="modal-content">
        <span class="close" onclick="closeApprovalModal()">&times;</span>
        <div class="modal-header">Approve Loan Application</div>
        <form method="POST" action="{% url 'dashboard:approve_loan_application' application.id %}">
            {% csrf_token %}
            <label for="approval-remarks" style="font-weight: bold; margin-bottom: 10px; display: block;">
                Approval Remarks (Optional):
            </label>
            <textarea id="approval-remarks" name="remarks" placeholder="Enter any comments or conditions for approval..."></textarea>
            <div class="modal-buttons">
                <button type="button" class="btn-action btn-back" onclick="closeApprovalModal()">Cancel</button>
                <button type="submit" class="btn-action btn-approve">Confirm Approval</button>
            </div>
        </form>
    </div>
</div>

<!-- Rejection Modal -->
<div id="rejectionModal" class="modal no-print">
    <div class="modal-content">
        <span class="close" onclick="closeRejectionModal()">&times;</span>
        <div class="modal-header">Reject Loan Application</div>
        <form method="POST" action="{% url 'dashboard:reject_loan_application' application.id %}">
            {% csrf_token %}
            <label for="rejection-remarks" style="font-weight: bold; margin-bottom: 10px; display: block;">
                Reason for Rejection <span style="color: red;">*</span>:
            </label>
            <textarea id="rejection-remarks" name="remarks" required placeholder="Enter reason for rejecting this loan application..."></textarea>
            <div class="modal-buttons">
                <button type="button" class="btn-action btn-back" onclick="closeRejectionModal()">Cancel</button>
                <button type="submit" class="btn-action btn-reject">Confirm Rejection</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openApprovalModal() {
        document.getElementById('approvalModal').style.display = 'block';
    }
    
    function closeApprovalModal() {
        document.getElementById('approvalModal').style.display = 'none';
    }
    
    function openRejectionModal() {
        document.getElementById('rejectionModal').style.display = 'block';
    }
    
    function closeRejectionModal() {
        document.getElementById('rejectionModal').style.display = 'none';
    }
    
    // Close modal when clicking outside of it
    window.onclick = function(event) {
        const approvalModal = document.getElementById('approvalModal');
        const rejectionModal = document.getElementById('rejectionModal');
        if (event.target == approvalModal) {
            closeApprovalModal();
        }
        if (event.target == rejectionModal) {
            closeRejectionModal();
        }
    }
</script>

{% endblock %}
