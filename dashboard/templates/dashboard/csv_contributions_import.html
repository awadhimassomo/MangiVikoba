{% extends "dashboard/base_dashboard_new.html" %}
{% load static %}

{% block title %}CSV Contributions Import - {{ current_kikoba.name }}{% endblock %}

{% block page_title %}CSV Contributions Import{% endblock %}

{% block dashboard_content %}
<div class="container mx-auto px-4 py-8">
    <div class="bg-white shadow-xl rounded-lg p-6">
        <div class="mb-6">
            <h2 class="text-2xl font-semibold text-gray-700 mb-2">Bulk Contributions Import for {{ current_kikoba.name }}</h2>
            <p class="text-gray-600">Import historical contributions using CSV files. Perfect for entering months or years of data at once!</p>
        </div>

        <!-- Process Steps -->
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg mb-8 border border-blue-100">
            <h3 class="text-lg font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-list-ol mr-2 text-blue-600"></i>
                How It Works
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-3">1</div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Download Template</h4>
                        <p class="text-sm text-gray-600">Generate a CSV file with your members and date periods</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold mr-3">2</div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Fill Data Offline</h4>
                        <p class="text-sm text-gray-600">Use Excel or Google Sheets to enter contribution amounts</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="flex-shrink-0 w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-bold mr-3">3</div>
                    <div>
                        <h4 class="font-semibold text-gray-700">Upload & Import</h4>
                        <p class="text-sm text-gray-600">Upload your filled CSV and we'll import all contributions</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Download Template -->
        <div class="mb-8 border border-gray-200 rounded-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-download mr-2 text-blue-600"></i>
                Step 1: Download CSV Template
            </h3>
            
            <form action="{% url 'dashboard:download_contributions_template' %}" method="GET" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label for="template_start_date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="template_start_date" name="start_date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bright-red focus:border-bright-red sm:text-sm">
                    </div>
                    
                    <div>
                        <label for="template_end_date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="template_end_date" name="end_date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bright-red focus:border-bright-red sm:text-sm">
                    </div>
                    
                    <div>
                        <label for="template_frequency" class="block text-sm font-medium text-gray-700 mb-1">Frequency</label>
                        <select id="template_frequency" name="frequency" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bright-red focus:border-bright-red sm:text-sm">
                            <option value="monthly">Monthly</option>
                            <option value="weekly">Weekly</option>
                            <option value="biweekly">Bi-Weekly</option>
                        </select>
                    </div>
                    
                    <div class="flex items-end">
                        <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow hover:shadow-md transition-all duration-150">
                            <i class="fas fa-download mr-2"></i>Download Template
                        </button>
                    </div>
                </div>
                
                <div class="bg-yellow-50 border border-yellow-200 rounded p-3">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-info-circle mr-1"></i>
                        The template will include all active members and generate columns for each period between the dates you specify.
                    </p>
                </div>
            </form>
        </div>

        <!-- Step 2: Upload Filled CSV -->
        <div class="mb-8 border border-gray-200 rounded-lg p-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                <i class="fas fa-upload mr-2 text-green-600"></i>
                Step 2: Upload Filled CSV
            </h3>
            
            <form action="{% url 'dashboard:upload_contributions_csv' %}" method="POST" enctype="multipart/form-data" class="space-y-4">
                {% csrf_token %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="contribution_type" class="block text-sm font-medium text-gray-700 mb-1">Contribution Type <span class="text-red-500">*</span></label>
                        <select id="contribution_type" name="contribution_type" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-bright-red focus:border-bright-red sm:text-sm">
                            <option value="">Select Type</option>
                            <option value="shares">Shares</option>
                            <option value="savings">Savings</option>
                            <option value="entry_fee">Entry Fee</option>
                            <option value="emergency_fund">Emergency Fund</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="csv_file" class="block text-sm font-medium text-gray-700 mb-1">CSV File <span class="text-red-500">*</span></label>
                        <input type="file" id="csv_file" name="csv_file" accept=".csv" required class="mt-1 block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none">
                    </div>
                </div>
                
                <div class="bg-blue-50 border border-blue-200 rounded p-3">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-lightbulb mr-1"></i>
                        <strong>Tips:</strong> Make sure you've filled in the amounts and haven't modified the Member ID, Name, or Phone columns.
                    </p>
                </div>
                
                <button type="submit" class="bg-gradient-to-r from-green-600 to-green-700 hover:from-green-700 hover:to-green-800 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:shadow-xl transition-all duration-150">
                    <i class="fas fa-cloud-upload-alt mr-2"></i>Upload & Import Contributions
                </button>
            </form>
        </div>

        <!-- Recent Imports -->
        <div class="border-t border-gray-200 pt-6">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Recent CSV Imports</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Date Imported</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Member</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Contribution Date</th>
                            <th class="py-3 px-4 text-right text-xs font-semibold text-gray-500 uppercase tracking-wider">Amount</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">Reference</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-200">
                        {% for contribution in recent_contributions %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-3 px-4 text-sm text-gray-900">{{ contribution.verified_at|date:"Y-m-d H:i" }}</td>
                            <td class="py-3 px-4 text-sm text-gray-900">{{ contribution.member.name }}</td>
                            <td class="py-3 px-4 text-sm text-gray-600">{{ contribution.date_contributed|date:"Y-m-d" }}</td>
                            <td class="py-3 px-4 text-sm text-gray-900 text-right font-medium">{{ contribution.amount|floatformat:2 }} TZS</td>
                            <td class="py-3 px-4 text-sm text-gray-600 font-mono text-xs">{{ contribution.transaction_reference }}</td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="5" class="py-6 px-4 text-center text-sm text-gray-500">No CSV imports yet.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Help Section -->
        <div class="mt-8 bg-gray-50 border border-gray-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-gray-700 mb-3">
                <i class="fas fa-question-circle mr-2 text-gray-600"></i>
                Need Help?
            </h3>
            <div class="space-y-2 text-sm text-gray-600">
                <p><strong>Q: What format should the CSV be?</strong></p>
                <p>A: Download the template first - it has the correct format with all members pre-filled.</p>
                
                <p class="mt-3"><strong>Q: Can I leave some cells empty?</strong></p>
                <p>A: Yes! Leave cells empty if a member didn't contribute for that period.</p>
                
                <p class="mt-3"><strong>Q: What if I have errors?</strong></p>
                <p>A: The system will show you which rows had errors. Valid contributions will still be imported.</p>
                
                <p class="mt-3"><strong>Q: Can I import data multiple times?</strong></p>
                <p>A: Yes, but be careful not to create duplicate entries for the same member and period.</p>
            </div>
        </div>
    </div>
</div>

<script>
    // Simple: Let users enter their own dates
    // No auto-population to avoid confusion about when Kikoba actually started vs when it was registered
</script>
{% endblock %}
